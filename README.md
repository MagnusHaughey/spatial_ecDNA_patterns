# SPatial ECdna Intratumor Evolution Simulation (SPECIES)

This repository contains the code for simulating the spatial patterns of ecDNA content within expanding tumour cell populations. The program generates an output file tissue.csv containing a list of the (x,y)-coordinates of all cells in the system, and the number of ecDNA copies the carry. Tested using Apple clang version 15.0.0 and Python v3.11.0.

Execute a single simulation by running:

```
g++ -o ./spatial_ecDNA_patterns_2D ./spatial_ecDNA_patterns_2D.cpp
./spatial_ecDNA_patterns_2D [--verbose] [-n N] [-k K] [-s S] [-q Q] [-x X]
```

where\
&nbsp; --verbose &emsp;&emsp; verbose flag (optional)\
&nbsp; -n &emsp;&emsp; maximum tumour size (in number of cells)\
&nbsp; -q &emsp;&emsp; cell pushing strength\
&nbsp; -k &emsp;&emsp; ecDNA copy number in initial cell\
&nbsp; -s &emsp;&emsp; selection strength. Scalar multiplier for the ecDNA dependent birth rate function, with s=0 giving rise to neutral growth and s>0 giving rise to positive ecDNA copy number dependent selection\
&nbsp; -x &emsp;&emsp; random seed

Flags should be specified before numerical arguments.

Run multiple simulations in a batch by editing the variables in the batch_run_parameters.txt file, then running:

```
bash ./batch_run.sh
```

Plot the final spatial data in tissue.csv by running:

```
python3 ./plot_spatial_data.py [--path PATH] [--plotCopyNumber]
```

where [PATH] is the file path the relevant tissue.csv file, and [--plotCopyNumber] specifies colouring cells according to their ecDNA copy number (if flag not specified, then cells are coloured according to ecDNA+ or ecDNA- status).

To perform parameter fitting (approximate Bayesian computation with rejection sampling) of the SPECIES spatial model to multi-region ecDNA copy number distributions (GB-UK cohort, data found in /GB_UK_ecDNA_copy_number_distributions/), run the following command:

```
bash ./ABC_full_algorithm.sh
```

Uniform prior distributions for parameters s and k are assumed, and the list of q values to simulate must be explicitly specified. Parameters of the prior distributions can be edited in the ABC_input_parameters.txt file. This outputs data to a file in a directory named /ABC_raw_results/, with each line of the file following the format: 

patient_ID,simulated_s,simulated_k,simulated_q,simulated_random_seed,tumourCore_wassersteinDistance,simulated_coreSample_radius,tumourMargin_wassersteinDistance,simulated_marginSample_centerCoordinateX,simulated_marginSample_centerCoordinateY,simulated_marginSample_radius,tumourLeadingEdge_wassersteinDistance,simulated_leadingEdgeSample_centerCoordinateX,simulated_leadingEdgeSample_centerCoordinateY,simulated_leadingEdgeSample_radius

Summarize the raw results generated by ./ABC_full_algorithm.sh by running the following command:

```
python3 ABC_summarize.py [--epsilon_core a] [--epsilon_margin b] [--epsilon_leadingEdge c] [--posterior_size d]
```

where the (optional) flags correspond to:

| Flag                  | Description | Default |
|-----------------------|-------------|---------|
| --epsilon_core        | Maximum permissable percentile for core distance            | 0.25    |
| --epsilon_margin      | Maximum permissable percentile for margin distance            | 0.25    |
| --epsilon_leadingEdge | Maximum permissable percentile for leading edge distance            | 0.25    |
| --posterior_size      |             | 0.25    |
